<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Bluetooth Example</title>
</head>
<body>
  <button id="scanButton">Scan for Xiaomi Bluetooth Devices</button>
  <ul id="deviceList"></ul>
  <p id="status"></p>

  <script>
    document.getElementById('scanButton').addEventListener('click', async () => {
      try {
        // 请求所有蓝牙设备
        const deviceArray = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true
        });

        // 过滤包含 "xiaomi" 名字的设备
        const xiaomiDevices = deviceArray.filter(device => device.name && device.name.toLowerCase().includes('xiaomi'));

        // 显示设备列表
        const deviceList = document.getElementById('deviceList');
        deviceList.innerHTML = ''; // 清空列表

        xiaomiDevices.forEach(device => {
          const listItem = document.createElement('li');
          listItem.innerText = device.name || 'Unknown Device';
          listItem.addEventListener('click', async () => {
            try {
              // 连接到 GATT 服务器
              const server = await device.gatt.connect();

              // 获取服务
              const service = await server.getPrimaryService('battery_service');

              // 获取特征
              const characteristic = await service.getCharacteristic('battery_level');

              // 读取特征值
              const value = await characteristic.readValue();
              const batteryLevel = value.getUint8(0);

              document.getElementById('status').innerText = `Connected to ${device.name || 'Unknown Device'}. Battery Level: ${batteryLevel}%`;
            } catch (error) {
              console.error('Error:', error);
              document.getElementById('status').innerText = `Error: ${error.message}`;
            }
          });

          deviceList.appendChild(listItem);
        });
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('status').innerText = `Error: ${error.message}`;
      }
    });
  </script>
</body>
</html>
